<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/my_carton.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/my_carton.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/my_carton.png">
  <link rel="mask-icon" href="/images/my_carton.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xudongyang.coding.me","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="一、推荐算法为何要精做特征工程机器学习工作流就好比是一个厨师做菜的过程，简单来说，清洗食材对应了清洗数据，食材的去皮、切片和搭配就对于了特征工程的过程，食物的烹饪对应了模型训练的过程。如果你觉得数据清洗和特征工程不重要，莫非是你想吃一份没有经过清洗、去皮、切片、调料，而直接把原始的带着泥沙的蔬菜瓜果放在大锅里乱炖出来的“菜”? 先不说卫生的问题，能不能弄熟了都是个问题。 在完整的机器学习流水线中，">
<meta property="og:type" content="article">
<meta property="og:title" content="1天学会开发工业级推荐系统的特征工程代码：保姆级教程">
<meta property="og:url" content="http://xudongyang.coding.me/feature-engineer-tutorial/index.html">
<meta property="og:site_name" content="小毛驴">
<meta property="og:description" content="一、推荐算法为何要精做特征工程机器学习工作流就好比是一个厨师做菜的过程，简单来说，清洗食材对应了清洗数据，食材的去皮、切片和搭配就对于了特征工程的过程，食物的烹饪对应了模型训练的过程。如果你觉得数据清洗和特征工程不重要，莫非是你想吃一份没有经过清洗、去皮、切片、调料，而直接把原始的带着泥沙的蔬菜瓜果放在大锅里乱炖出来的“菜”? 先不说卫生的问题，能不能弄熟了都是个问题。 在完整的机器学习流水线中，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangxudong/blogimg@master/rec/ecommerce_event_type.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangxudong/blogimg@master/rec/ecommerce_category.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangxudong/blogimg@master/rec/ecommerce_price.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangxudong/blogimg@master/rec/ecommerce_event_time.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangxudong/blogimg@master/rec/gauss_rank.74d1pfo7xg40.png">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-38e9426d072024927ccec02f2cf6a35a_1440w.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/yangxudong/blogimg@master/rec/woe.jpg">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-f7a62e4cafc21245014c5ab9b0b2a32b_1440w.jpg">
<meta property="article:published_time" content="2022-06-05T03:21:50.000Z">
<meta property="article:modified_time" content="2022-09-04T03:28:22.351Z">
<meta property="article:author" content="yangxudong">
<meta property="article:tag" content="推荐算法">
<meta property="article:tag" content="特征工程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/yangxudong/blogimg@master/rec/ecommerce_event_type.jpg">

<link rel="canonical" href="http://xudongyang.coding.me/feature-engineer-tutorial/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>1天学会开发工业级推荐系统的特征工程代码：保姆级教程 | 小毛驴</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="小毛驴" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">小毛驴</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Adventure may hurt you, but monotony will kill you.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-essays">

    <a href="/categories/essays/" rel="section"><i class="fa fa-leaf fa-fw"></i>软技能</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xudongyang.coding.me/feature-engineer-tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/my_carton.png">
      <meta itemprop="name" content="yangxudong">
      <meta itemprop="description" content="勤劳的小毛驴">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小毛驴">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          1天学会开发工业级推荐系统的特征工程代码：保姆级教程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-06-05 11:21:50" itemprop="dateCreated datePublished" datetime="2022-06-05T11:21:50+08:00">2022-06-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-04 11:28:22" itemprop="dateModified" datetime="2022-09-04T11:28:22+08:00">2022-09-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">推荐系统</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/feature-engineer-tutorial/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/feature-engineer-tutorial/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>21k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>19 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="一、推荐算法为何要精做特征工程"><a href="#一、推荐算法为何要精做特征工程" class="headerlink" title="一、推荐算法为何要精做特征工程"></a>一、推荐算法为何要精做特征工程</h2><p>机器学习工作流就好比是一个厨师做菜的过程，简单来说，清洗食材对应了清洗数据，食材的去皮、切片和搭配就对于了特征工程的过程，食物的烹饪对应了模型训练的过程。如果你觉得数据清洗和特征工程不重要，莫非是你想吃一份没有经过清洗、去皮、切片、调料，而直接把原始的带着泥沙的蔬菜瓜果放在大锅里乱炖出来的“菜”? 先不说卫生的问题，能不能弄熟了都是个问题。</p>
<p>在完整的机器学习流水线中，特征工程通常占据了数据科学家很大一部分的精力，是因为特征工程能够显著提升模型性能，高质量的特征能够大大简化模型复杂度，让模型变得高效且易理解、易维护。在机器学习领域，“Garbage In, Garbage Out”是业界的共识，对于一个机器学习问题，数据和特征决定了机器学习的上限，而模型和算法只是逼近这个上限而已。</p>
<p>与计算机视觉、语音、NLP等领域不同，推荐算法模型很大程度上依赖人工特征工程为其提供输入数据，这是因为推荐算法需要处理的通常是结构化的关系型数据，这些原始数据一般需要经过清洗、采样、变换、统计、编码等方式生成最终的特征数据，模型本身无法直接完成所有这些加工逻辑。关于工业级推荐系统中如何做特征工程，请参考这篇文章《<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/518308463">工业级推荐系统中的特征工程</a>》。</p>
<p>上面这篇文章从一个较概括和抽象的角度详细介绍了工业级推荐系统中如何做特征工程，但并未提及代码实现方面的内容。本文的目标就是帮助读者理解并掌握这些特征工程方法在真实的生成环境中是如何实现的。本文从一个公开数据集出发，详细讲解一个工业级推荐系统的特征工程代码是如何一步一步开发出来的。开发语言为MaxCompute SQL，非常类似于Hive/Spark SQL。</p>
<p>查看本文完整代码：<a target="_blank" rel="noopener" href="https://github.com/yangxudong/feature_engineering">Github</a><br><a id="more"></a></p>
<h2 id="二、数据集简介"><a href="#二、数据集简介" class="headerlink" title="二、数据集简介"></a>二、数据集简介</h2><p>本文使用的训练、评估、测试数据集来自<a target="_blank" rel="noopener" href="https://rees46.com/">REES46 Marketing Platform</a>的<a target="_blank" rel="noopener" href="https://www.kaggle.com/mkechinov/ecommerce-behavior-data-from-multi-category-store">多类目电商平台的行为数据</a>。该数据集包含了电商平台从2019年10月到2020年4月的28.5亿条用户行为记录。</p>
<p>数据集中的每一行表示一个用户对一个商品行为事件。数据集的Schema如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Property</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>event_time</td>
<td>Time when event happened at (in UTC).</td>
</tr>
<tr>
<td>event_type</td>
<td>one kind of event: view, cart, purchase.</td>
</tr>
<tr>
<td>product_id</td>
<td>ID of a product</td>
</tr>
<tr>
<td>category_id</td>
<td>Product’s category ID</td>
</tr>
<tr>
<td>category_code</td>
<td>Product’s category taxonomy (code name) if it was possible to make it. Usually present for meaningful categories and skipped for different kinds of accessories.</td>
</tr>
<tr>
<td>brand</td>
<td>Downcased string of brand name. Can be missed.</td>
</tr>
<tr>
<td>price</td>
<td>Float price of a product. Present.</td>
</tr>
<tr>
<td>user_id</td>
<td>Permanent user ID.</td>
</tr>
<tr>
<td><strong>user_session</strong></td>
<td>Temporary user’s session ID. Same for each user’s session. Is changed every time user come back to online store from a long pause.</td>
</tr>
</tbody>
</table>
</div>
<p><em>Event types</em><br>事件类型包括：</p>
<ul>
<li>view - 用户浏览了某个商品</li>
<li>cart - 用户把某个商品加入了购物车</li>
<li>purchase - 用户购买了某个商品</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/yangxudong/blogimg@master/rec/ecommerce_event_type.jpg" alt></p>
<p><em>User Session</em><br>用户会话：</p>
<ul>
<li>一次会话中可能包含了多个用户行为，甚至多个购买行为。</li>
</ul>
<h3 id="数据探查"><a href="#数据探查" class="headerlink" title="数据探查"></a>数据探查</h3><p>示例数据：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>event_time</th>
<th>event_type</th>
<th>product_id</th>
<th>category_id</th>
<th>category_code</th>
<th>brand</th>
<th>price</th>
<th>user_id</th>
<th>user_session</th>
</tr>
</thead>
<tbody>
<tr>
<td>2019-11-01 00:00:00 UTC</td>
<td>view</td>
<td>1003461</td>
<td>2053013555631882655</td>
<td>electronics.smartphone</td>
<td>xiaomi</td>
<td>489.07</td>
<td>520088904</td>
<td>4d3b30da-a5e4-49df-b1a8-ba5943f1dd33</td>
</tr>
<tr>
<td>2019-11-01 00:00:00 UTC</td>
<td>view</td>
<td>5000088</td>
<td>2053013566100866035</td>
<td>appliances.sewing_machine</td>
<td>janome</td>
<td>293.65</td>
<td>530496790</td>
<td>8e5f4f83-366c-4f70-860e-ca7417414283</td>
</tr>
<tr>
<td>2019-11-01 00:00:01 UTC</td>
<td>view</td>
<td>1004775</td>
<td>2053013555631882655</td>
<td>electronics.smartphone</td>
<td>xiaomi</td>
<td>183.27</td>
<td>558856683</td>
<td>313628f1-68b8-460d-84f6-cec7a8796ef2</td>
</tr>
<tr>
<td>2019-11-01 00:01:04 UTC</td>
<td>purchase</td>
<td>1005161</td>
<td>2053013555631882655</td>
<td>electronics.smartphone</td>
<td>xiaomi</td>
<td>211.92</td>
<td>513351129</td>
<td>e6b7ce9b-1938-4e20-976c-8b4163aea11d</td>
</tr>
<tr>
<td>2019-11-01 00:06:33 UTC</td>
<td>purchase</td>
<td>1801881</td>
<td>2053013554415534427</td>
<td>electronics.video.tv</td>
<td>samsung</td>
<td>488.80</td>
<td>557746614</td>
<td>4d76d6d3-fff5-4880-8327-e9e57b618e0e</td>
</tr>
<tr>
<td>2019-11-01 00:07:38 UTC</td>
<td>purchase</td>
<td>30000218</td>
<td>2127425436764865054</td>
<td>construction.tools.welding</td>
<td>magnetta</td>
<td>254.78</td>
<td>515240495</td>
<td>0253151d-5c84-4809-ba02-38ac405494e1</td>
</tr>
</tbody>
</table>
</div>
<p>以2019年十一月的数据为例，展示一些统计数据。</p>
<ul>
<li>记录数：67501979</li>
<li>category_code<ul>
<li>[null]: 32%</li>
<li>lectronics.smartphone: 24%</li>
<li>other: 43%</li>
<li><img src="https://cdn.jsdelivr.net/gh/yangxudong/blogimg@master/rec/ecommerce_category.jpg" alt="ecommerce_category"></li>
</ul>
</li>
<li>brand<ul>
<li>[null]: 14%</li>
<li>samsung: 12%</li>
<li>other: 75%</li>
<li>Top Brands</li>
</ul>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>brand</th>
<th>count</th>
</tr>
</thead>
<tbody>
<tr>
<td>samsung</td>
<td>198670</td>
</tr>
<tr>
<td>apple</td>
<td>165681</td>
</tr>
<tr>
<td>xiaomi</td>
<td>57909</td>
</tr>
<tr>
<td>huawei</td>
<td>23466</td>
</tr>
<tr>
<td>oppo</td>
<td>15080</td>
</tr>
<tr>
<td>lg</td>
<td>11828</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>user_session<ul>
<li>唯一值个数：13776051</li>
</ul>
</li>
<li>price<ul>
<li>mean: 292</li>
<li>std. Deviation: 356</li>
<li>min: 0</li>
<li>max: 2.57k</li>
<li><img src="https://cdn.jsdelivr.net/gh/yangxudong/blogimg@master/rec/ecommerce_price.jpg" alt="ecommerce_price"></li>
</ul>
</li>
<li>event_time (Vistors Daily Trend)<ul>
<li>Does traffic flunctuate by date?</li>
<li><img src="https://cdn.jsdelivr.net/gh/yangxudong/blogimg@master/rec/ecommerce_event_time.jpg" alt="ecommerce_event_time"></li>
</ul>
</li>
</ul>
<h2 id="三、任务目标"><a href="#三、任务目标" class="headerlink" title="三、任务目标"></a>三、任务目标</h2><p>建立模型预测用户在加购某商品后，最终是否会购买。</p>
<p>根据上述学习目标，通过下列准则构建样本标签：</p>
<ul>
<li>正样本：用户购买了某商品</li>
<li>负样本：用户把某商品加入购物车，但之后并没有购买（在同一session内）</li>
<li>浏览行为不用来构建样本（但可以用来做特征）</li>
</ul>
<p>数据集的划分方法如下：</p>
<ul>
<li>训练集：19年11月-20年2月</li>
<li>验证集：20年3月</li>
<li>测试集：20年4月</li>
</ul>
<p>其中，19年10月的数据不用来做训练，是因为特征构建时最长的统计周期是30天，10月份的数据在一些统计值上会发生统计不完全的问题。</p>
<h2 id="四、特征工程"><a href="#四、特征工程" class="headerlink" title="四、特征工程"></a>四、特征工程</h2><p>限于篇幅的原因，我们在文章中只展示部分代码，完整的代码请查看<a target="_blank" rel="noopener" href="https://github.com/yangxudong/feature_engineering">Github</a>。</p>
<p>首先，我们创建一个和原始数据对应schema的MaxCompute Table <code>ecommerce_behavior</code>，并把从Kaggle下载的数据集通过 <code>odpscmd</code> 的 <code>tunnel</code> 命令上传至 MaxCompute平台。举例如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> ecommerce_behavior</span><br><span class="line">(</span><br><span class="line">    event_time    <span class="keyword">STRING</span>,</span><br><span class="line">    event_type    <span class="keyword">STRING</span>,</span><br><span class="line">    product_id    <span class="built_in">BIGINT</span>,</span><br><span class="line">    category_id   <span class="built_in">BIGINT</span>,</span><br><span class="line">    category_code <span class="keyword">STRING</span>,</span><br><span class="line">    brand         <span class="keyword">STRING</span>,</span><br><span class="line">    price         <span class="keyword">DOUBLE</span>,</span><br><span class="line">    user_id       <span class="built_in">BIGINT</span>,</span><br><span class="line">    user_session  <span class="keyword">STRING</span></span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span></span><br><span class="line">(</span><br><span class="line">    dt            <span class="keyword">STRING</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">odpscmd -e &quot;tunnel u -cf true -h true -acp true  2020-Apr.csv ecommerce_behavior/dt=202004;&quot;</span><br></pre></td></tr></table></figure></p>
<p>在预处理阶段，category_code（类目路径）被分裂为<code>cat_0</code>,<code>cat_1</code>,<code>cat_2</code>三个字段，分别表示一级类目、二级类目、三级类目；根据event_time生成两个新的特征：ts_weekday（value: 0-7），ts_hour（value: 0-23），分别表示星期几和几点钟。代码如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> ecommerce_behavior_table <span class="keyword">PARTITION</span>(dt)</span><br><span class="line"><span class="keyword">SELECT</span> *, <span class="keyword">DATEPART</span>(event_time,<span class="string">&#x27;hh&#x27;</span>) ts_hour, <span class="keyword">WEEKDAY</span>(event_time) ts_weekday,</span><br><span class="line">    TO_CHAR(event_time, <span class="string">&#x27;yyyymmdd&#x27;</span>) <span class="keyword">as</span> dt</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> DATETIME(<span class="keyword">replace</span>(event_time, <span class="string">&#x27; UTC&#x27;</span>, <span class="string">&#x27;&#x27;</span>)) <span class="keyword">as</span> event_time,</span><br><span class="line">        event_type, product_id, category_id, category_code, brand, price,</span><br><span class="line">        user_id, user_session, <span class="keyword">split</span>(category_code, <span class="string">&#x27;\\.&#x27;</span>)[<span class="number">0</span>] cat_0,</span><br><span class="line">        <span class="keyword">split</span>(category_code, <span class="string">&#x27;\\.&#x27;</span>)[<span class="number">1</span>] cat_1,</span><br><span class="line">        <span class="keyword">split</span>(category_code, <span class="string">&#x27;\\.&#x27;</span>)[<span class="number">2</span>] cat_2,</span><br><span class="line">        <span class="keyword">split</span>(category_code, <span class="string">&#x27;\\.&#x27;</span>)[<span class="number">3</span>] cat_3</span><br><span class="line">    <span class="keyword">FROM</span> ecommerce_behavior</span><br><span class="line">    <span class="keyword">WHERE</span> dt &gt; <span class="number">0</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="1-缺失值填充"><a href="#1-缺失值填充" class="headerlink" title="1. 缺失值填充"></a>1. 缺失值填充</h3><p>通过数据分析发现，类目和品牌字段存在一些缺失值，由于类目和品牌都属于<code>类别型</code>特征，在其他处理之前我们用一个固定值“UNKNOWN”填充缺失值。</p>
<h3 id="2-生成价格档位-amp-价格环比Diff-Ratio"><a href="#2-生成价格档位-amp-价格环比Diff-Ratio" class="headerlink" title="2. 生成价格档位 &amp; 价格环比Diff Ratio"></a>2. 生成价格档位 &amp; 价格环比Diff Ratio</h3><p>电商场景下，购买需求很大程度上受到价格因素的影响，因此价格是一个很重要的特征。然而，由于商品价格的跨度非常大，从前面数据探查的结果可以看出，该数据集上价格基本上遵循幂律分布。我们需要一个特征来度量该商品是“贵”还是“便宜”，以及“贵”或“便宜”的程度是多少，然而不同类目的商品价格区间是不一样的，如果不考虑商品的品类，那么价格的绝对值是无法度量商品是“贵”还是“便宜”的。通常我们会认为200块钱买一部手机是便宜的，但是100块钱买一瓶饮料却非常贵。</p>
<p>我们可以对商品价格做<code>z-score</code>标准化来生成输入给模型的特征。</p>
<script type="math/tex; mode=display">norm\_price=\frac{price-mean_c(price)}{std_c(price)}</script><p>其中，$mean_c(price)$表示类目$c$的商品的平均价格，$std_c(price)$表示类目$c$的商品价格的标准差。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> category_price_info</span><br><span class="line">(</span><br><span class="line">    category_id <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;商品类目ID&#x27;</span>,</span><br><span class="line">    avg_price <span class="keyword">DOUBLE</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;当前类目下的平均价格&#x27;</span>,</span><br><span class="line">    std_price <span class="keyword">DOUBLE</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;当前类目下价格的标准差&#x27;</span></span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (dt <span class="keyword">STRING</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;日期&#x27;</span>)</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> category_price_info <span class="keyword">PARTITION</span>(dt)</span><br><span class="line"><span class="keyword">SELECT</span> category_id, <span class="keyword">AVG</span>(price) avg_price, <span class="keyword">STDDEV_SAMP</span>(price) std_price, dt</span><br><span class="line"><span class="keyword">FROM</span> ecommerce_item_table</span><br><span class="line"><span class="keyword">WHERE</span> dt&gt;<span class="number">0</span> <span class="keyword">AND</span> category_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AND</span> price <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dt, category_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 请查看`ecommerce_behavior_wide_table`表的生成代码</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">if</span>(std_price=<span class="number">0.0</span>, <span class="number">0.0</span>, (price-avg_price)/std_price) <span class="keyword">as</span> norm_price, ...</span><br></pre></td></tr></table></figure>
<p>转换后的$norm_price$服从标准的正态分布，对于大多数模型，尤其是深度神经网络这样的模型，是非常友好的；这点可以从深度学习常用的<code>batch normalization</code>技术上得到验证。</p>
<p>好了，现在我们有一个可以度量商品“贵”或“便宜”的程度特征了。然而，现实中有很多用户对不同品类的商品的价格敏感度是不一样的，比如某用户可能喜欢买贵的电子产品，同时也偏好便宜的日用品。如果我们还需要度量某用户对不同品类的价格的偏好程度，那么仅仅有$norm_price$还是不够的，因为$norm_price$是一个连续值，没法直接和其他特征做交叉统计。进一步，我们可以对价格做档位划分，比如可以在每个类目下把商品按照价格从低到高排序，然后通过分位点划分为10个宽度相等的区间，把区间的编号作为商品的价格档位。SQL代码如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> price_level_lookup_table <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> product_id, category_id, <span class="keyword">MIN</span>(price_level) price_level</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> product_id, category_id,</span><br><span class="line">        NTILE(<span class="number">10</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> category_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> price)<span class="number">-1</span> <span class="keyword">AS</span> price_level</span><br><span class="line">    <span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> product_id, category_id, price</span><br><span class="line">        <span class="keyword">FROM</span> ecommerce_item_table</span><br><span class="line">        <span class="keyword">WHERE</span> dt &gt; <span class="number">0</span></span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> product_id, category_id;</span><br></pre></td></tr></table></figure>
<p>上述步骤得到的<code>price_level</code>是一个值域为[0, 10)的离散值，可以和类目、用户组合成新特征，以及在新的组合特征的基础上生成新的统计特征。</p>
<p>在经济学中，价格是影响供给和需求的重要因素。价格的变化会显著影响需求量，因此把价格的变化建模到特征中会是一个不错的选择。我们构建了当前商品价格与前一天的最小价格之间的差异变化率作为特征。</p>
<h3 id="3-Categorifying"><a href="#3-Categorifying" class="headerlink" title="3. Categorifying"></a>3. Categorifying</h3><p>对于类别型特征，如商品的类目、品牌等，推荐首先做<code>Categorifying</code>，即把类别型特征转换为该特征值的列表的索引位置(index)，得到一个从0到$|C|$的非负整数，这里$|C|$表示该特征唯一值的个数。</p>
<p><code>Categorifying</code>操作的好处是可以节省在线feature store的存储空间，因为原来的字符串值都被转换成了数字。同时，<code>Categorifying</code>的结果可以更方便地输入给深度神经网络模型的Embedding Layers，反之，如果不做<code>Categorifying</code>那么就需要的对原始类别型特征做hash之后，再去查Embedding Lookup Table，为了防止hash冲突，通常Embedding Lookup Table的长度都设置得比实际需要的更大，这样就会让模型多了很多不必要的参数，给模型的存储和分发都带来了额外的负担。</p>
<p><code>Categorifying</code>的代码如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> category_lookup_table <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> category_id, ROW_NUMBER() <span class="keyword">OVER</span>() - <span class="number">1</span> <span class="keyword">AS</span> category_idx</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> category_id</span><br><span class="line">    <span class="keyword">FROM</span> ecommerce_item_table</span><br><span class="line">    <span class="keyword">WHERE</span> dt &gt; <span class="number">0</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="4-分箱-amp-组合"><a href="#4-分箱-amp-组合" class="headerlink" title="4. 分箱 &amp; 组合"></a>4. 分箱 &amp; 组合</h3><p>之前提到的价格档位就是一种分箱操作，除此之外，我们还可以自定义分箱的边界。比如，对于时间<code>ts_hour</code>字段我们可以根据统计数据分析自定义如下分箱边界，生成新的特征<code>hour_bin</code>。</p>
<ol>
<li>0-3 Night: 较低的购买概率</li>
<li>4-7 Early morning: 中等的购买概率</li>
<li>8-14 Morning/Lunch: 较高的购买概率</li>
<li>15-20 Afternoon: 较低的购买概率</li>
<li>21-23: Evening: 高购买概率</li>
</ol>
<p>组合特征是一个常用的特征转换操作。有时候单个独立的类别型特征对于目标的预测帮助不大，但把两个或多个特征组合起来时就能够很好地帮助模型预测目标。比如，我们可以把weekday和hour_bin组合起来。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 完整代码请查看 `ecommerce_behavior_view` 试图的生成代码</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">        <span class="keyword">WHEN</span> ts_hour&lt;=<span class="number">3</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">WHEN</span> ts_hour&lt;=<span class="number">7</span> <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">WHEN</span> ts_hour&lt;=<span class="number">14</span> <span class="keyword">THEN</span> <span class="number">2</span></span><br><span class="line">        <span class="keyword">WHEN</span> ts_hour&lt;=<span class="number">20</span> <span class="keyword">THEN</span> <span class="number">3</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="number">4</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> hour_bin, ...</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(ts_weekday, <span class="string">&#x27;_&#x27;</span>, hour_bin) <span class="keyword">as</span> weekday_hour</span><br></pre></td></tr></table></figure>
<h3 id="5-样本去重和标签生成"><a href="#5-样本去重和标签生成" class="headerlink" title="5. 样本去重和标签生成"></a>5. 样本去重和标签生成</h3><p>我们把同一用户在同一session中对同一商品的多个相同类型的行为事件判定为重复样本，再接下来的生成统计特征之前，我们先执行样本去重，SQL的主要逻辑如下。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 完整代码请查看 `ecommerce_behavior_view` 试图的生成代码</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">`(rn)?+.+`</span></span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> ...,</span><br><span class="line">        ROW_NUMBER() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id, user_session, product_id, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> event_time <span class="keyword">DESC</span>) rn</span><br><span class="line">    <span class="keyword">FROM</span> ecommerce_behavior_table</span><br><span class="line">    <span class="keyword">WHERE</span> dt&gt;=@bizdate</span><br><span class="line">)</span><br><span class="line"><span class="keyword">WHERE</span> rn=<span class="number">1</span> <span class="comment">-- drop_duplicates</span></span><br></pre></td></tr></table></figure>
<p>下一小节要介绍的上下文特征需要依赖样本去重逻辑的执行才能正确计算出来。</p>
<p>根据学习任务的目标，定义用户在同一session中购买了某商品后，该session中当前用户对目标商品的所有行为事件都关联正样本的标签，否则关联负样本的标签。代码如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> ecommerce_session_purchase(@bizdate <span class="keyword">STRING</span>)</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> NVL(user_session, <span class="string">&#x27;UNKNOWN&#x27;</span>) user_session, user_id, product_id,</span><br><span class="line">    <span class="keyword">MAX</span>(<span class="keyword">IF</span>(event_type=<span class="string">&#x27;purchase&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>)) is_purchased <span class="comment">-- label</span></span><br><span class="line"><span class="keyword">FROM</span> ecommerce_behavior_table</span><br><span class="line"><span class="keyword">WHERE</span> dt&gt;=@bizdate</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> NVL(user_session, <span class="string">&#x27;UNKNOWN&#x27;</span>), user_id, product_id</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<p>后续介绍的统计特征都需要依赖标签来做Target Encoding相关的操作。</p>
<h3 id="6-上下文特征"><a href="#6-上下文特征" class="headerlink" title="6. 上下文特征"></a>6. 上下文特征</h3><p>由于数据集提供的字段比较少，因此我们能够利用的上下文特征比较有限。我们构建的一个比较重要的上下文特征为 <code>activity_count</code>, 即当前session中到目前为止的行为次数。我们使用窗口函数<code>SUM</code>的累积求和功能来计算<code>activity_count</code>的值，代码如下。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> ecommerce_behavior_wide_table <span class="keyword">PARTITION</span>(dt)</span><br><span class="line"><span class="keyword">SELECT</span> is_purchased, event_time, event_type, A.product_id, category_id, category_code, brand, price, A.user_id,</span><br><span class="line">  A.user_session, cat_0, cat_1, cat_2, ts_hour, ts_weekday, hour_bin, weekday_hour, product_idx, category_idx,</span><br><span class="line">  brand_idx, cat_0_idx, cat_1_idx, cat_2_idx, code_idx, price_level,</span><br><span class="line">  <span class="keyword">SUM</span>(<span class="keyword">IF</span>(event_type <span class="keyword">IN</span> (<span class="string">&quot;purchase&quot;</span>, <span class="string">&quot;cart&quot;</span>), <span class="number">1</span>, <span class="number">0</span>)) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> A.user_session <span class="keyword">ORDER</span> <span class="keyword">BY</span> event_time) <span class="keyword">as</span> activity_count,</span><br><span class="line">  <span class="keyword">if</span>(std_price=<span class="number">0.0</span>, <span class="number">0.0</span>, (price-avg_price)/std_price) <span class="keyword">as</span> norm_price,</span><br><span class="line">  A.dt</span><br><span class="line"><span class="keyword">FROM</span> ecommerce_behavior_view(<span class="string">&#x27;0&#x27;</span>) A</span><br><span class="line"><span class="keyword">JOIN</span> ecommerce_session_purchase(<span class="string">&#x27;0&#x27;</span>) B</span><br><span class="line"><span class="keyword">ON</span> A.dt=B.dt <span class="keyword">AND</span> A.user_session = B.user_session <span class="keyword">AND</span> A.product_id=B.product_id <span class="keyword">AND</span> A.user_id=B.user_id</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<h3 id="7-特征值统计"><a href="#7-特征值统计" class="headerlink" title="7. 特征值统计"></a>7. 特征值统计</h3><p>在搜索、推荐、广告场景下，基于类别型特征生成新的统计特征是常规做法。个人认为，成功的特征工程要达成的目标就是降低使用复杂的模型的必要性。好的特征本身应该具有很好的信息量和区分度，不再需要模型本身的有很强的建模能力。那么，如何才能构建既有信息量又有区分度的特征呢？</p>
<p>在推荐场景下，对类别型特征或者执行分箱操作之后的数值型特征进行统计编码是常见套路，这一过程称之为<code>bin-counting</code>，详情请查看《<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/518308463">工业级推荐系统中的特征工程</a>》。</p>
<p>首先，我们需要一些基础的计数统计值，以CTR预估为例，目标是预测用户是否回点击某Item，那么我们需要如下统计计数值：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>User</th>
<th>Number of clicks</th>
<th>Number of non-clicks</th>
</tr>
</thead>
<tbody>
<tr>
<td>Alice</td>
<td>27</td>
<td>534</td>
</tr>
<tr>
<td>Bob</td>
<td>96</td>
<td>235</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>Joe</td>
<td>9</td>
<td>374</td>
</tr>
</tbody>
</table>
</div>
<p>我们还需要对特征之间的交叉组合做正负样本的统计，如用户对不同商品类目的行为计数：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>User,Category</th>
<th>Number of clicks</th>
<th>Number of non-clicks</th>
</tr>
</thead>
<tbody>
<tr>
<td>Alice,1001</td>
<td>7</td>
<td>134</td>
</tr>
<tr>
<td>Bob,1002</td>
<td>17</td>
<td>235</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>Joe,1101</td>
<td>2</td>
<td>274</td>
</tr>
</tbody>
</table>
</div>
<p>在实际的应该过程中，我们需要统计不同时间周期、不同行为类型以及不同组合特征下正、负样本的计数值，并基于这些统计值做特征编码。</p>
<p>首先，按业务日期统计商品、以及商品属性（看成是一种binning的结果）不同行为类型下的正、负样本数量：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> ecommerce_item_count_daily</span><br><span class="line">(</span><br><span class="line">    field_idx   <span class="built_in">BIGINT</span>,</span><br><span class="line">    event_type  <span class="keyword">STRING</span>,</span><br><span class="line">    total_cnt   <span class="built_in">BIGINT</span>,</span><br><span class="line">    positive_cnt <span class="built_in">BIGINT</span>,</span><br><span class="line">    probs       <span class="keyword">DOUBLE</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">COMMENT</span> <span class="string">&#x27;item field counting&#x27;</span></span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (<span class="keyword">field</span> <span class="keyword">STRING</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;field name&#x27;</span>, dt <span class="keyword">STRING</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;yyyymmdd&#x27;</span>)</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">FROM (</span><br><span class="line">    <span class="keyword">SELECT</span> *</span><br><span class="line">    <span class="keyword">FROM</span> ecommerce_behavior_wide_table</span><br><span class="line">    <span class="keyword">WHERE</span> dt &gt; <span class="number">0</span> <span class="keyword">AND</span> event_type <span class="keyword">IN</span> (<span class="string">&#x27;purchase&#x27;</span>, <span class="string">&#x27;cart&#x27;</span>, <span class="string">&#x27;view&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> ecommerce_item_count_daily <span class="keyword">PARTITION</span>(<span class="keyword">field</span>=<span class="string">&#x27;product&#x27;</span>, dt)</span><br><span class="line"><span class="keyword">SELECT</span> product_idx, event_type, <span class="keyword">COUNT</span>(<span class="number">1</span>) cnt, <span class="keyword">SUM</span>(is_purchased) positive_cnt, <span class="keyword">AVG</span>(is_purchased) probs, dt</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> product_idx, event_type, dt</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> ecommerce_item_count_daily <span class="keyword">PARTITION</span>(<span class="keyword">field</span>=<span class="string">&#x27;price_level&#x27;</span>, dt)</span><br><span class="line"><span class="keyword">SELECT</span> price_level, event_type, <span class="keyword">COUNT</span>(<span class="number">1</span>) cnt, <span class="keyword">SUM</span>(is_purchased) positive_cnt, <span class="keyword">AVG</span>(is_purchased) probs, dt</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> price_level, event_type, dt</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> ecommerce_item_count_daily <span class="keyword">PARTITION</span>(<span class="keyword">field</span>=<span class="string">&#x27;cate_price_level&#x27;</span>, dt)</span><br><span class="line"><span class="keyword">SELECT</span> category_idx*<span class="number">10</span>+price_level, event_type, <span class="keyword">COUNT</span>(<span class="number">1</span>) cnt, <span class="keyword">SUM</span>(is_purchased) positive_cnt, <span class="keyword">AVG</span>(is_purchased) probs, dt</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> category_idx, price_level, event_type, dt</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> ecommerce_item_count_daily <span class="keyword">PARTITION</span>(<span class="keyword">field</span>=<span class="string">&#x27;category&#x27;</span>, dt)</span><br><span class="line"><span class="keyword">SELECT</span> category_idx, event_type, <span class="keyword">COUNT</span>(<span class="number">1</span>) cnt, <span class="keyword">SUM</span>(is_purchased) positive_cnt, <span class="keyword">AVG</span>(is_purchased) probs, dt</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> category_idx, event_type, dt</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>然后，按照最近1天、3天、7天、30天的时间滑动窗口，统计不同field的不同<code>bin</code>在不同行为类型下的正负样本数量，以及当前field在不同类型的行为下全局正负样本数量。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> ecommerce_item_cumulate_count <span class="keyword">PARTITION</span>(<span class="keyword">field</span>, dt)</span><br><span class="line"><span class="keyword">SELECT</span> field_idx, event_type,</span><br><span class="line">    total_cnt_1d, pos_cnt_1d, total_cnt_1d-pos_cnt_1d <span class="keyword">AS</span> neg_cnt_1d,</span><br><span class="line">    <span class="keyword">SUM</span>(pos_cnt_1d) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, <span class="keyword">field</span>, event_type) global_pos_cnt_1d,</span><br><span class="line">    <span class="keyword">SUM</span>(total_cnt_1d-pos_cnt_1d) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, <span class="keyword">field</span>, event_type) global_neg_cnt_1d,</span><br><span class="line">    total_cnt_3d, pos_cnt_3d, total_cnt_3d-pos_cnt_3d <span class="keyword">AS</span> neg_cnt_3d,</span><br><span class="line">    <span class="keyword">SUM</span>(pos_cnt_3d) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, <span class="keyword">field</span>, event_type) global_pos_cnt_3d,</span><br><span class="line">    <span class="keyword">SUM</span>(total_cnt_3d-pos_cnt_3d) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, <span class="keyword">field</span>, event_type) global_neg_cnt_3d,</span><br><span class="line">    total_cnt_7d, pos_cnt_7d, total_cnt_7d-pos_cnt_7d <span class="keyword">AS</span> neg_cnt_7d,</span><br><span class="line">    <span class="keyword">SUM</span>(pos_cnt_7d) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, <span class="keyword">field</span>, event_type) global_pos_cnt_7d,</span><br><span class="line">    <span class="keyword">SUM</span>(total_cnt_7d-pos_cnt_7d) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, <span class="keyword">field</span>, event_type) global_neg_cnt_7d,</span><br><span class="line">    total_cnt_30d, pos_cnt_30d, total_cnt_30d-pos_cnt_30d <span class="keyword">AS</span> neg_cnt_30d,</span><br><span class="line">    <span class="keyword">SUM</span>(pos_cnt_30d) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, <span class="keyword">field</span>, event_type) global_pos_cnt_30d,</span><br><span class="line">    <span class="keyword">SUM</span>(total_cnt_30d-pos_cnt_30d) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, <span class="keyword">field</span>, event_type) global_neg_cnt_30d,</span><br><span class="line">    <span class="keyword">field</span>, dt</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> field_idx, event_type, total_cnt <span class="keyword">as</span> total_cnt_1d, positive_cnt <span class="keyword">as</span> pos_cnt_1d,</span><br><span class="line">        <span class="keyword">SUM</span>(total_cnt) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">field</span>, field_idx, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> dt <span class="keyword">ASC</span> <span class="keyword">ROWS</span> <span class="number">2</span> <span class="keyword">PRECEDING</span>) total_cnt_3d,</span><br><span class="line">        <span class="keyword">SUM</span>(positive_cnt) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">field</span>, field_idx, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> dt <span class="keyword">ASC</span> <span class="keyword">ROWS</span> <span class="number">2</span> <span class="keyword">PRECEDING</span>) pos_cnt_3d,</span><br><span class="line">        <span class="keyword">SUM</span>(total_cnt) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">field</span>, field_idx, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> dt <span class="keyword">ASC</span> <span class="keyword">ROWS</span> <span class="number">6</span> <span class="keyword">PRECEDING</span>) total_cnt_7d,</span><br><span class="line">        <span class="keyword">SUM</span>(positive_cnt) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">field</span>, field_idx, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> dt <span class="keyword">ASC</span> <span class="keyword">ROWS</span> <span class="number">6</span> <span class="keyword">PRECEDING</span>) pos_cnt_7d,</span><br><span class="line">        <span class="keyword">SUM</span>(total_cnt) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">field</span>, field_idx, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> dt <span class="keyword">ASC</span> <span class="keyword">ROWS</span> <span class="number">29</span> <span class="keyword">PRECEDING</span>) total_cnt_30d,</span><br><span class="line">        <span class="keyword">SUM</span>(positive_cnt) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">field</span>, field_idx, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> dt <span class="keyword">ASC</span> <span class="keyword">ROWS</span> <span class="number">29</span> <span class="keyword">PRECEDING</span>) pos_cnt_30d,</span><br><span class="line">        <span class="keyword">field</span>, dt</span><br><span class="line">    <span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="keyword">field</span>, event_type, field_idx, TO_CHAR(<span class="keyword">DATEADD</span>(<span class="keyword">TO_DATE</span>(dt, <span class="string">&#x27;yyyymmdd&#x27;</span>), delta, <span class="string">&#x27;dd&#x27;</span>), <span class="string">&#x27;yyyymmdd&#x27;</span>) dt,</span><br><span class="line">            <span class="keyword">SUM</span>(<span class="built_in">BIGINT</span>(NVL(total_cnt, <span class="number">0</span>))) total_cnt, <span class="keyword">SUM</span>(<span class="built_in">BIGINT</span>(NVL(positive_cnt, <span class="number">0</span>))) positive_cnt</span><br><span class="line">        <span class="keyword">FROM</span> (</span><br><span class="line">            <span class="keyword">SELECT</span> TRANS_ARRAY(<span class="number">4</span>, <span class="string">&#x27;,&#x27;</span>, dt, <span class="keyword">field</span>, event_type, field_idx, <span class="keyword">string</span>(total_cnt), <span class="keyword">string</span>(positive_cnt), <span class="keyword">range</span>(<span class="number">0</span>, <span class="number">30</span>))</span><br><span class="line">                <span class="keyword">AS</span> (dt, <span class="keyword">field</span>, event_type, field_idx, total_cnt, positive_cnt, delta)</span><br><span class="line">            <span class="keyword">FROM</span> ecommerce_item_count_daily</span><br><span class="line">            <span class="keyword">WHERE</span> dt&gt;<span class="number">0</span> <span class="keyword">AND</span> <span class="keyword">field</span> <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="string">&#x27;weekday_hour&#x27;</span>, <span class="string">&#x27;product&#x27;</span>) <span class="keyword">AND</span> event_type != <span class="string">&#x27;purchase&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> TO_CHAR(<span class="keyword">DATEADD</span>(<span class="keyword">TO_DATE</span>(dt, <span class="string">&#x27;yyyymmdd&#x27;</span>), delta, <span class="string">&#x27;dd&#x27;</span>), <span class="string">&#x27;yyyymmdd&#x27;</span>), <span class="keyword">field</span>, event_type, field_idx</span><br><span class="line">    )</span><br><span class="line">)</span><br><span class="line"><span class="keyword">WHERE</span> dt&lt;<span class="string">&#x27;20200501&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h3 id="8-统计特征变换"><a href="#8-统计特征变换" class="headerlink" title="8. 统计特征变换"></a>8. 统计特征变换</h3><p>对应统计得到的数值型特征，通常有两种特征变换方法：缩放(scaling)和分箱(binning)。</p>
<p>推荐系统的统计特征推荐使用 <code>gauss rank</code> 的特征缩放方法或者基于分位点的分箱方法（等频分箱）。</p>
<p><img src="https://cdn.jsdelivr.net/gh/yangxudong/blogimg@master/rec/gauss_rank.74d1pfo7xg40.png" alt="gauss_rank"></p>
<p><code>gauss rank</code> 特征缩放的过程如上图所示，首先对特征值进行排序，然后缩放到 (-1,1) 的区间，最后调用一个逆误差函数 <code>erfinv</code> 得到高斯分布的特征值。</p>
<h3 id="9-统计特征编码"><a href="#9-统计特征编码" class="headerlink" title="9. 统计特征编码"></a>9. 统计特征编码</h3><p>下面介绍几种常用的特征编码方法。</p>
<h4 id="a-Count-Encoding"><a href="#a-Count-Encoding" class="headerlink" title="a) Count Encoding"></a>a) Count Encoding</h4><p>统计该类别型特征不同行为类型、不同时间周期内的发生的频次。直接用统计值作为特征，需要先做特征缩放（e.g. gauss rank）或分箱。</p>
<h4 id="b-Target-Encoding"><a href="#b-Target-Encoding" class="headerlink" title="b) Target Encoding"></a>b) Target Encoding</h4><p>统计该类别型特征不同行为类型、不同时间周期内的目标转化率（如目标是点击则为点击率，如目标是成交则为购买率）。<br>目标转化率需要考虑置信度的问题，当置信度不够的时候，需要做平滑，拿全局或者分组的平均转化率当当前特征的转化率做一个平滑，公式如下。</p>
<p><img src="https://pic3.zhimg.com/80/v2-38e9426d072024927ccec02f2cf6a35a_1440w.png" alt></p>
<h4 id="c-优势比（Odds-Ratio）"><a href="#c-优势比（Odds-Ratio）" class="headerlink" title="c) 优势比（Odds Ratio）"></a>c) 优势比（Odds Ratio）</h4><p>优势比告诉我们某种推测的概率比其反向推测的概率大多少，公式如下。</p>
<script type="math/tex; mode=display">\theta=\frac{p_1/(1-p_1)}{p_2/(1-p_2)}</script><p>例：用户Alice的点击事件</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>Click</th>
<th>Non-Click</th>
<th>Total</th>
</tr>
</thead>
<tbody>
<tr>
<td>Alice</td>
<td>5</td>
<td>120</td>
<td>125</td>
</tr>
<tr>
<td>Not Alice</td>
<td>995</td>
<td>18880</td>
<td>19875</td>
</tr>
<tr>
<td>Total</td>
<td>1000</td>
<td>19000</td>
<td>20000</td>
</tr>
</tbody>
</table>
</div>
<p>在我们的例子中，<code>优势比</code>意味着“爱丽丝点击相对于不点击的可能性”和“其他人点击相对于不点击的可能性“相比有多大。在这种情况下，计算出的数字是：</p>
<script type="math/tex; mode=display">\frac{(5/125)/(120/125)}{(995/19875)/(18880/19875)}=0.7906</script><p><code>优势比</code>的值有可能会非常小或非常大（例如，可能会有几乎不会点击的用户），因此我们可以对其进行简化，并加一个log转换使得除法变成减法：$log(N^+)-log(N^-)$。</p>
<h4 id="d-证据权重（Weight-Of-Evidence）"><a href="#d-证据权重（Weight-Of-Evidence）" class="headerlink" title="d) 证据权重（Weight Of Evidence）"></a>d) 证据权重（Weight Of Evidence）</h4><p>Weight of evidence (WOE) 和 Information value (IV) 是简单有效的变量变换和选择方法，在二分类问题中也是很好的特征。</p>
<script type="math/tex; mode=display">WOE=ln\left( \frac{Event\%}{Non Event\%} \right)</script><p><img src="https://cdn.jsdelivr.net/gh/yangxudong/blogimg@master/rec/woe.jpg" alt="woe"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> ecommerce_user_bin_count_v2 <span class="keyword">PARTITION</span>(<span class="keyword">field</span>, dt)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">30</span>d.user_id, <span class="number">30</span>d.field_idx, <span class="number">30</span>d.event_type,</span><br><span class="line">    nvl(pos_ntile_1d, <span class="number">9</span>), nvl(neg_ntile_1d, <span class="number">9</span>), nvl(pos_ntile_3d, <span class="number">9</span>), nvl(neg_ntile_3d, <span class="number">9</span>),</span><br><span class="line">    nvl(pos_ntile_7d, <span class="number">9</span>), nvl(neg_ntile_7d, <span class="number">9</span>), nvl(pos_ntile_30d, <span class="number">9</span>), nvl(neg_ntile_30d, <span class="number">9</span>),</span><br><span class="line">    nvl(pos_gauss_rank_1d, <span class="number">0</span>), nvl(neg_gauss_rank_1d, <span class="number">0</span>), nvl(pos_gauss_rank_3d, <span class="number">0</span>), nvl(neg_gauss_rank_3d, <span class="number">0</span>),</span><br><span class="line">    nvl(pos_gauss_rank_7d, <span class="number">0</span>), nvl(neg_gauss_rank_7d, <span class="number">0</span>), nvl(pos_gauss_rank_30d, <span class="number">0</span>), nvl(neg_gauss_rank_30d, <span class="number">0</span>),</span><br><span class="line">    nvl(woe_1d, <span class="number">0</span>), nvl(woe_3d, <span class="number">0</span>), nvl(woe_7d, <span class="number">0</span>), nvl(woe_30d, <span class="number">0</span>),</span><br><span class="line">    nvl(odds_1d, <span class="number">0</span>), nvl(odds_3d, <span class="number">0</span>), nvl(odds_7d, <span class="number">0</span>), nvl(odds_30d, <span class="number">0</span>),</span><br><span class="line">    nvl(odds_ratio_1d, <span class="number">0</span>), nvl(odds_ratio_3d, <span class="number">0</span>), nvl(odds_ratio_7d, <span class="number">0</span>), nvl(odds_ratio_30d, <span class="number">0</span>),</span><br><span class="line">    <span class="number">30</span>d.field, <span class="number">30</span>d.dt</span><br><span class="line"><span class="keyword">FROM</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> dt, <span class="keyword">field</span>, user_id, field_idx, event_type,</span><br><span class="line">        pos_ntile_30d, neg_ntile_30d,</span><br><span class="line">        GAUSS_RANK(pos_rank_30d) pos_gauss_rank_30d,</span><br><span class="line">        GAUSS_RANK(neg_rank_30d) neg_gauss_rank_30d,</span><br><span class="line">        <span class="keyword">LN</span>(<span class="number">1e-6</span>+pos_ratio_30d/(<span class="number">1e-6</span>+neg_ratio_30d)) <span class="keyword">AS</span> woe_30d,</span><br><span class="line">        odds_30d, odds_ratio_30d</span><br><span class="line">    <span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> dt, user_id, <span class="keyword">field</span>, field_idx, event_type,</span><br><span class="line">            NTILE(<span class="number">10</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> pos_cnt_30d <span class="keyword">DESC</span>)<span class="number">-1</span> <span class="keyword">AS</span> pos_ntile_30d,</span><br><span class="line">            NTILE(<span class="number">10</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> neg_cnt_30d <span class="keyword">DESC</span>)<span class="number">-1</span> <span class="keyword">AS</span> neg_ntile_30d,</span><br><span class="line">            <span class="keyword">PERCENT_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> pos_cnt_30d <span class="keyword">DESC</span>) <span class="keyword">AS</span> pos_rank_30d,</span><br><span class="line">            <span class="keyword">PERCENT_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> neg_cnt_30d <span class="keyword">DESC</span>) <span class="keyword">AS</span> neg_rank_30d,</span><br><span class="line">            <span class="keyword">if</span>(global_pos_cnt_30d=<span class="number">0</span>, <span class="number">0</span>, pos_cnt_30d/global_pos_cnt_30d) <span class="keyword">AS</span> pos_ratio_30d,</span><br><span class="line">            <span class="keyword">if</span>(global_neg_cnt_30d=<span class="number">0</span>, <span class="number">0</span>, neg_cnt_30d/global_neg_cnt_30d) <span class="keyword">AS</span> neg_ratio_30d,</span><br><span class="line">            <span class="keyword">LN</span>(<span class="number">1e-6</span> + pos_cnt_30d)-<span class="keyword">LN</span>(<span class="number">1e-6</span> + neg_cnt_30d) <span class="keyword">AS</span> odds_30d,</span><br><span class="line">            <span class="keyword">LN</span>(<span class="number">1e-6</span>+pos_cnt_30d)-<span class="keyword">LN</span>(<span class="number">1e-6</span>+neg_cnt_30d)-<span class="keyword">LN</span>(<span class="number">1e-6</span>+global_pos_cnt_30d-pos_cnt_30d)+<span class="keyword">LN</span>(<span class="number">1e-6</span>+global_neg_cnt_30d-neg_cnt_30d) <span class="keyword">AS</span> odds_ratio_30d</span><br><span class="line">        <span class="keyword">FROM</span> ecommerce_user_cumulate_count</span><br><span class="line">        <span class="keyword">where</span> dt&gt;=<span class="string">&#x27;20191031&#x27;</span> <span class="keyword">AND</span> total_cnt_30d&gt;<span class="number">0</span></span><br><span class="line">    )</span><br><span class="line">) <span class="number">30</span>d</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> dt, <span class="keyword">field</span>, user_id, field_idx, event_type,</span><br><span class="line">        pos_ntile_7d, neg_ntile_7d,</span><br><span class="line">        GAUSS_RANK(pos_rank_7d) pos_gauss_rank_7d,</span><br><span class="line">        GAUSS_RANK(neg_rank_7d) neg_gauss_rank_7d,</span><br><span class="line">        <span class="keyword">LN</span>(<span class="number">1e-6</span>+pos_ratio_7d/(<span class="number">1e-6</span>+neg_ratio_7d)) <span class="keyword">AS</span> woe_7d,</span><br><span class="line">        odds_7d, odds_ratio_7d</span><br><span class="line">    <span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> dt, user_id, <span class="keyword">field</span>, field_idx, event_type,</span><br><span class="line">            NTILE(<span class="number">10</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> pos_cnt_7d <span class="keyword">DESC</span>)<span class="number">-1</span> <span class="keyword">AS</span> pos_ntile_7d,</span><br><span class="line">            NTILE(<span class="number">10</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> neg_cnt_7d <span class="keyword">DESC</span>)<span class="number">-1</span> <span class="keyword">AS</span> neg_ntile_7d,</span><br><span class="line">            <span class="keyword">PERCENT_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> pos_cnt_7d <span class="keyword">DESC</span>) <span class="keyword">AS</span> pos_rank_7d,</span><br><span class="line">            <span class="keyword">PERCENT_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> neg_cnt_7d <span class="keyword">DESC</span>) <span class="keyword">AS</span> neg_rank_7d,</span><br><span class="line">            <span class="keyword">if</span>(global_pos_cnt_7d=<span class="number">0</span>, <span class="number">0</span>, pos_cnt_7d/global_pos_cnt_7d) <span class="keyword">AS</span> pos_ratio_7d,</span><br><span class="line">            <span class="keyword">if</span>(global_neg_cnt_7d=<span class="number">0</span>, <span class="number">0</span>, neg_cnt_7d/global_neg_cnt_7d) <span class="keyword">AS</span> neg_ratio_7d,</span><br><span class="line">            <span class="keyword">LN</span>(<span class="number">1e-6</span> + pos_cnt_7d) - <span class="keyword">LN</span>(<span class="number">1e-6</span> + neg_cnt_7d) <span class="keyword">AS</span> odds_7d,</span><br><span class="line">            <span class="keyword">LN</span>(<span class="number">1e-6</span>+pos_cnt_7d)-<span class="keyword">LN</span>(<span class="number">1e-6</span>+neg_cnt_7d)-<span class="keyword">LN</span>(<span class="number">1e-6</span>+global_pos_cnt_7d-pos_cnt_7d)+<span class="keyword">LN</span>(<span class="number">1e-6</span>+global_neg_cnt_7d-neg_cnt_7d) <span class="keyword">AS</span> odds_ratio_7d</span><br><span class="line">        <span class="keyword">FROM</span> ecommerce_user_cumulate_count</span><br><span class="line">        <span class="keyword">where</span> dt&gt;=<span class="string">&#x27;20191031&#x27;</span> <span class="keyword">AND</span> total_cnt_7d&gt;<span class="number">0</span></span><br><span class="line">    )</span><br><span class="line">) <span class="number">7</span>d</span><br><span class="line"><span class="keyword">ON</span> <span class="number">30</span>d.dt=<span class="number">7</span>d.dt <span class="keyword">AND</span> <span class="number">30</span>d.field=<span class="number">7</span>d.field <span class="keyword">AND</span> <span class="number">30</span>d.user_id=<span class="number">7</span>d.user_id <span class="keyword">AND</span> <span class="number">30</span>d.event_type=<span class="number">7</span>d.event_type <span class="keyword">AND</span> <span class="number">30</span>d.field_idx=<span class="number">7</span>d.field_idx</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> dt, <span class="keyword">field</span>, user_id, field_idx, event_type,</span><br><span class="line">        pos_ntile_3d, neg_ntile_3d,</span><br><span class="line">        GAUSS_RANK(pos_rank_3d) pos_gauss_rank_3d,</span><br><span class="line">        GAUSS_RANK(neg_rank_3d) neg_gauss_rank_3d,</span><br><span class="line">        <span class="keyword">LN</span>(<span class="number">1e-6</span>+pos_ratio_3d/(<span class="number">1e-6</span>+neg_ratio_3d)) <span class="keyword">AS</span> woe_3d,</span><br><span class="line">        odds_3d, odds_ratio_3d</span><br><span class="line">    <span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> dt, user_id, <span class="keyword">field</span>, field_idx, event_type,</span><br><span class="line">            NTILE(<span class="number">10</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> pos_cnt_3d <span class="keyword">DESC</span>)<span class="number">-1</span> <span class="keyword">AS</span> pos_ntile_3d,</span><br><span class="line">            NTILE(<span class="number">10</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> neg_cnt_3d <span class="keyword">DESC</span>)<span class="number">-1</span> <span class="keyword">AS</span> neg_ntile_3d,</span><br><span class="line">            <span class="keyword">PERCENT_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> pos_cnt_3d <span class="keyword">DESC</span>) <span class="keyword">AS</span> pos_rank_3d,</span><br><span class="line">            <span class="keyword">PERCENT_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> neg_cnt_3d <span class="keyword">DESC</span>) <span class="keyword">AS</span> neg_rank_3d,</span><br><span class="line">            <span class="keyword">if</span>(global_pos_cnt_3d=<span class="number">0</span>, <span class="number">0</span>, pos_cnt_3d/global_pos_cnt_3d) <span class="keyword">AS</span> pos_ratio_3d,</span><br><span class="line">            <span class="keyword">if</span>(global_neg_cnt_3d=<span class="number">0</span>, <span class="number">0</span>, neg_cnt_3d/global_neg_cnt_3d) <span class="keyword">AS</span> neg_ratio_3d,</span><br><span class="line">            <span class="keyword">LN</span>(<span class="number">1e-6</span> + pos_cnt_3d) - <span class="keyword">LN</span>(<span class="number">1e-6</span> + neg_cnt_3d) <span class="keyword">AS</span> odds_3d,</span><br><span class="line">            <span class="keyword">LN</span>(<span class="number">1e-6</span>+pos_cnt_3d)-<span class="keyword">LN</span>(<span class="number">1e-6</span>+neg_cnt_3d)-<span class="keyword">LN</span>(<span class="number">1e-6</span>+global_pos_cnt_3d-pos_cnt_3d)+<span class="keyword">LN</span>(<span class="number">1e-6</span>+global_neg_cnt_3d-neg_cnt_3d) <span class="keyword">AS</span> odds_ratio_3d</span><br><span class="line">        <span class="keyword">FROM</span> ecommerce_user_cumulate_count</span><br><span class="line">        <span class="keyword">where</span> dt&gt;=<span class="string">&#x27;20191031&#x27;</span> <span class="keyword">AND</span> total_cnt_3d&gt;<span class="number">0</span></span><br><span class="line">    )</span><br><span class="line">) <span class="number">3</span>d</span><br><span class="line"><span class="keyword">ON</span> <span class="number">30</span>d.dt=<span class="number">3</span>d.dt <span class="keyword">AND</span> <span class="number">30</span>d.field=<span class="number">3</span>d.field <span class="keyword">AND</span> <span class="number">30</span>d.user_id=<span class="number">3</span>d.user_id <span class="keyword">AND</span> <span class="number">30</span>d.event_type=<span class="number">3</span>d.event_type <span class="keyword">AND</span> <span class="number">30</span>d.field_idx=<span class="number">3</span>d.field_idx</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> dt, <span class="keyword">field</span>, user_id, field_idx, event_type,</span><br><span class="line">        pos_ntile_1d, neg_ntile_1d,</span><br><span class="line">        GAUSS_RANK(pos_rank_1d) pos_gauss_rank_1d,</span><br><span class="line">        GAUSS_RANK(neg_rank_1d) neg_gauss_rank_1d,</span><br><span class="line">        <span class="keyword">LN</span>(<span class="number">1e-6</span>+pos_ratio_1d/(<span class="number">1e-6</span>+neg_ratio_1d)) <span class="keyword">AS</span> woe_1d,</span><br><span class="line">        odds_1d, odds_ratio_1d</span><br><span class="line">    <span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> dt, user_id, <span class="keyword">field</span>, field_idx, event_type,</span><br><span class="line">            NTILE(<span class="number">10</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> pos_cnt_1d <span class="keyword">DESC</span>)<span class="number">-1</span> <span class="keyword">AS</span> pos_ntile_1d,</span><br><span class="line">            NTILE(<span class="number">10</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> neg_cnt_1d <span class="keyword">DESC</span>)<span class="number">-1</span> <span class="keyword">AS</span> neg_ntile_1d,</span><br><span class="line">            <span class="keyword">PERCENT_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> pos_cnt_1d <span class="keyword">DESC</span>) <span class="keyword">AS</span> pos_rank_1d,</span><br><span class="line">            <span class="keyword">PERCENT_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dt, user_id, <span class="keyword">field</span>, event_type <span class="keyword">ORDER</span> <span class="keyword">BY</span> neg_cnt_1d <span class="keyword">DESC</span>) <span class="keyword">AS</span> neg_rank_1d,</span><br><span class="line">            <span class="keyword">if</span>(global_pos_cnt_1d=<span class="number">0</span>, <span class="number">0</span>, pos_cnt_1d/global_pos_cnt_1d) <span class="keyword">AS</span> pos_ratio_1d,</span><br><span class="line">            <span class="keyword">if</span>(global_neg_cnt_1d=<span class="number">0</span>, <span class="number">0</span>, neg_cnt_1d/global_neg_cnt_1d) <span class="keyword">AS</span> neg_ratio_1d,</span><br><span class="line">            <span class="keyword">LN</span>(<span class="number">1e-6</span> + pos_cnt_1d) - <span class="keyword">LN</span>(<span class="number">1e-6</span> + neg_cnt_1d) <span class="keyword">AS</span> odds_1d,</span><br><span class="line">            <span class="keyword">LN</span>(<span class="number">1e-6</span>+pos_cnt_1d)-<span class="keyword">LN</span>(<span class="number">1e-6</span>+neg_cnt_1d)-<span class="keyword">LN</span>(<span class="number">1e-6</span>+global_pos_cnt_1d-pos_cnt_1d)+<span class="keyword">LN</span>(<span class="number">1e-6</span>+global_neg_cnt_1d-neg_cnt_1d) <span class="keyword">AS</span> odds_ratio_1d</span><br><span class="line">        <span class="keyword">FROM</span> ecommerce_user_cumulate_count</span><br><span class="line">        <span class="keyword">where</span> dt&gt;=<span class="string">&#x27;20191031&#x27;</span> <span class="keyword">AND</span> total_cnt_1d&gt;<span class="number">0</span></span><br><span class="line">    )</span><br><span class="line">) <span class="number">1</span>d</span><br><span class="line"><span class="keyword">ON</span> <span class="number">30</span>d.dt=<span class="number">1</span>d.dt <span class="keyword">AND</span> <span class="number">30</span>d.field=<span class="number">1</span>d.field <span class="keyword">AND</span> <span class="number">30</span>d.user_id=<span class="number">1</span>d.user_id <span class="keyword">AND</span> <span class="number">30</span>d.event_type=<span class="number">1</span>d.event_type <span class="keyword">AND</span> <span class="number">30</span>d.field_idx=<span class="number">1</span>d.field_idx</span><br><span class="line">;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="10-整体流程"><a href="#10-整体流程" class="headerlink" title="10. 整体流程"></a>10. 整体流程</h3><p>详情请查看《<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/518308463">工业级推荐系统中的特征工程</a>》。<br><img src="https://pic4.zhimg.com/80/v2-f7a62e4cafc21245014c5ab9b0b2a32b_1440w.jpg" alt></p>
<p>模型训练的代码请查看<a target="_blank" rel="noopener" href="https://github.com/yangxudong/feature_engineering">GitHub</a>。</p>
<h2 id="五、实验结果"><a href="#五、实验结果" class="headerlink" title="五、实验结果"></a>五、实验结果</h2><div class="table-container">
<table>
<thead>
<tr>
<th>模型</th>
<th>AUC</th>
<th>GAUC</th>
<th>Recall</th>
<th>Precision</th>
<th>F1 Score</th>
<th>remark</th>
</tr>
</thead>
<tbody>
<tr>
<td>MLP-gauss</td>
<td>0.633</td>
<td>0.476</td>
<td>0.393</td>
<td>0.579</td>
<td>0.46825</td>
<td>odds+woe/item</td>
</tr>
<tr>
<td>MLP-ntile</td>
<td>0.642</td>
<td>0.474</td>
<td>0.400</td>
<td>0.584</td>
<td>0.474727</td>
<td>-</td>
</tr>
<tr>
<td>GBDT v2</td>
<td>0.558</td>
<td>0.562</td>
<td>0.681</td>
<td>0.444</td>
<td>0.537114</td>
<td>-</td>
</tr>
<tr>
<td>GBDT on od</td>
<td>0.549</td>
<td>0.539</td>
<td>0.867</td>
<td>0.439</td>
<td>0.58277</td>
<td>-</td>
</tr>
<tr>
<td>GBDT on ow</td>
<td>0.585</td>
<td>0.594</td>
<td>0.815</td>
<td>0.447</td>
<td>0.57738</td>
<td>-</td>
</tr>
<tr>
<td>LR</td>
<td>0.649</td>
<td>0.583</td>
<td>0.370</td>
<td>0.592</td>
<td>0.455</td>
<td>-</td>
</tr>
</tbody>
</table>
</div>
<h2 id="六、特征重要度分析"><a href="#六、特征重要度分析" class="headerlink" title="六、特征重要度分析"></a>六、特征重要度分析</h2><p>根据GBDT算法中特征带来的信息增益计算出特征重要度如下(截取了Top N个)：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>name</th>
<th>importance</th>
</tr>
</thead>
<tbody>
<tr>
<td>user_cat_0_cart_odds_ratio_30d</td>
<td>0.06663279235363007</td>
</tr>
<tr>
<td>weekday_hour</td>
<td>0.05106705102843989</td>
</tr>
<tr>
<td>user_cat_2_purchase_gauss_rank_7d</td>
<td>0.04943003132939339</td>
</tr>
<tr>
<td>cat_2_cart_odds_ratio_1d</td>
<td>0.042615607380867004</td>
</tr>
<tr>
<td>user_cat_0_view_gini_30d</td>
<td>0.0248174536973238</td>
</tr>
<tr>
<td>brand_cart_gini_7d</td>
<td>0.023471875116229057</td>
</tr>
<tr>
<td>cat_1_view_gini_7d</td>
<td>0.021432124078273773</td>
</tr>
<tr>
<td>category_cart_odds_ratio_1d</td>
<td>0.017213333398103714</td>
</tr>
<tr>
<td>cate_hour_cart_woe_30d</td>
<td>0.016498396173119545</td>
</tr>
<tr>
<td>code_view_gini_1d</td>
<td>0.015937425196170807</td>
</tr>
<tr>
<td>cat_0_cart_info_value_30d</td>
<td>0.01512192189693451</td>
</tr>
<tr>
<td>price_level_view_chi_square_1d</td>
<td>0.014924108050763607</td>
</tr>
<tr>
<td>cate_price_level_cart_woe_3d</td>
<td>0.013924989849328995</td>
</tr>
<tr>
<td>cat_2_view_gini_7d</td>
<td>0.01232975721359253</td>
</tr>
<tr>
<td>user_cat_2_cart_odds_ratio_30d</td>
<td>0.012204065918922424</td>
</tr>
</tbody>
</table>
</div>
<p>原文链接：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/524575369">https://zhuanlan.zhihu.com/p/524575369</a></p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="yangxudong 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpg" alt="yangxudong 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%8E%A8%E8%8D%90%E7%AE%97%E6%B3%95/" rel="tag"># 推荐算法</a>
              <a href="/tags/%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B/" rel="tag"># 特征工程</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/feature-engineer/" rel="prev" title="工业级推荐算法中的特征工程">
      <i class="fa fa-chevron-left"></i> 工业级推荐算法中的特征工程
    </a></div>
      <div class="post-nav-item">
    <a href="/rec-multi-modal/" rel="next" title="视觉多模态推荐算法综述">
      视觉多模态推荐算法综述 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%8E%A8%E8%8D%90%E7%AE%97%E6%B3%95%E4%B8%BA%E4%BD%95%E8%A6%81%E7%B2%BE%E5%81%9A%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">一、推荐算法为何要精做特征工程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%95%B0%E6%8D%AE%E9%9B%86%E7%AE%80%E4%BB%8B"><span class="nav-number">2.</span> <span class="nav-text">二、数据集简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%8E%A2%E6%9F%A5"><span class="nav-number">2.1.</span> <span class="nav-text">数据探查</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E4%BB%BB%E5%8A%A1%E7%9B%AE%E6%A0%87"><span class="nav-number">3.</span> <span class="nav-text">三、任务目标</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B"><span class="nav-number">4.</span> <span class="nav-text">四、特征工程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%BC%BA%E5%A4%B1%E5%80%BC%E5%A1%AB%E5%85%85"><span class="nav-number">4.1.</span> <span class="nav-text">1. 缺失值填充</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%94%9F%E6%88%90%E4%BB%B7%E6%A0%BC%E6%A1%A3%E4%BD%8D-amp-%E4%BB%B7%E6%A0%BC%E7%8E%AF%E6%AF%94Diff-Ratio"><span class="nav-number">4.2.</span> <span class="nav-text">2. 生成价格档位 &amp; 价格环比Diff Ratio</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Categorifying"><span class="nav-number">4.3.</span> <span class="nav-text">3. Categorifying</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E5%88%86%E7%AE%B1-amp-%E7%BB%84%E5%90%88"><span class="nav-number">4.4.</span> <span class="nav-text">4. 分箱 &amp; 组合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%A0%B7%E6%9C%AC%E5%8E%BB%E9%87%8D%E5%92%8C%E6%A0%87%E7%AD%BE%E7%94%9F%E6%88%90"><span class="nav-number">4.5.</span> <span class="nav-text">5. 样本去重和标签生成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E4%B8%8A%E4%B8%8B%E6%96%87%E7%89%B9%E5%BE%81"><span class="nav-number">4.6.</span> <span class="nav-text">6. 上下文特征</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E7%89%B9%E5%BE%81%E5%80%BC%E7%BB%9F%E8%AE%A1"><span class="nav-number">4.7.</span> <span class="nav-text">7. 特征值统计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E7%BB%9F%E8%AE%A1%E7%89%B9%E5%BE%81%E5%8F%98%E6%8D%A2"><span class="nav-number">4.8.</span> <span class="nav-text">8. 统计特征变换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E7%BB%9F%E8%AE%A1%E7%89%B9%E5%BE%81%E7%BC%96%E7%A0%81"><span class="nav-number">4.9.</span> <span class="nav-text">9. 统计特征编码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-Count-Encoding"><span class="nav-number">4.9.1.</span> <span class="nav-text">a) Count Encoding</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-Target-Encoding"><span class="nav-number">4.9.2.</span> <span class="nav-text">b) Target Encoding</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E4%BC%98%E5%8A%BF%E6%AF%94%EF%BC%88Odds-Ratio%EF%BC%89"><span class="nav-number">4.9.3.</span> <span class="nav-text">c) 优势比（Odds Ratio）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-%E8%AF%81%E6%8D%AE%E6%9D%83%E9%87%8D%EF%BC%88Weight-Of-Evidence%EF%BC%89"><span class="nav-number">4.9.4.</span> <span class="nav-text">d) 证据权重（Weight Of Evidence）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="nav-number">4.10.</span> <span class="nav-text">10. 整体流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C"><span class="nav-number">5.</span> <span class="nav-text">五、实验结果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E7%89%B9%E5%BE%81%E9%87%8D%E8%A6%81%E5%BA%A6%E5%88%86%E6%9E%90"><span class="nav-number">6.</span> <span class="nav-text">六、特征重要度分析</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yangxudong"
      src="/images/my_carton.png">
  <p class="site-author-name" itemprop="name">yangxudong</p>
  <div class="site-description" itemprop="description">勤劳的小毛驴</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">58</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">74</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/yangxudong" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yangxudong" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yangxudongsuda@gmail.com" title="E-Mail → mailto:yangxudongsuda@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/1192649764" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;1192649764" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/u/0/115853952463021385464" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;u&#x2F;0&#x2F;115853952463021385464" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/%E6%97%AD%E4%B8%9C-%E6%9D%A8-755131169/" title="LinkedIn → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;%E6%97%AD%E4%B8%9C-%E6%9D%A8-755131169&#x2F;" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i>LinkedIn</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://www.jianshu.com/users/4e1990280df6/latest_articles" title="简书 → http:&#x2F;&#x2F;www.jianshu.com&#x2F;users&#x2F;4e1990280df6&#x2F;latest_articles" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>简书</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://zhuanlan.zhihu.com/yangxudong" title="知乎 → https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;yangxudong" rel="noopener" target="_blank"><i class="fab fa-zhihu fa-fw"></i>知乎</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://blog.csdn.net/yangxudong" title="CSDN → http:&#x2F;&#x2F;blog.csdn.net&#x2F;yangxudong" rel="noopener" target="_blank"><i class="fa fa-blog fa-fw"></i>CSDN</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://www.cnblogs.com/yangxudong/" title="博客园 → http:&#x2F;&#x2F;www.cnblogs.com&#x2F;yangxudong&#x2F;" rel="noopener" target="_blank"><i class="fab fa-blogger fa-fw"></i>博客园</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://yang_xu_dong.gitee.io/" title="https:&#x2F;&#x2F;yang_xu_dong.gitee.io" rel="noopener" target="_blank">国内镜像</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yangxudong</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">370k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:37</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : true,
      appId      : 'bYp6b0sgetOuSC5AAozB3yNN-gzGzoHsz',
      appKey     : 'tGnUPDp3vyWfTglwVpttySAy',
      placeholder: "快快献上你的评论～",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
